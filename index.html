<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
// Configuraci√≥n MQTT
const mqttClient = mqtt.connect('wss://broker.hivemq.com:8884/mqtt');
let latestESP32Data = null;

mqttClient.on('connect', function () {
    console.log('‚úÖ MQTT conectado');
    mqttClient.subscribe('kontrol-gas/esp32/weight', function (err) {
        if (!err) {
            console.log('‚úÖ Suscrito a topic MQTT');
        }
    });
});

mqttClient.on('message', function (topic, message) {
    try {
        const data = JSON.parse(message.toString());
        latestESP32Data = {
            ...data,
            received_at: Date.now()
        };
        console.log('üì• Datos MQTT recibidos:', data.weight, 'kg');
        
        // Actualizar dashboard inmediatamente
        updateDataFromMQTT();
    } catch (error) {
        console.error('‚ùå Error procesando MQTT:', error);
    }
});

// Funci√≥n para actualizar dashboard con datos MQTT
function updateDataFromMQTT() {
    if (!latestESP32Data) return;
    
    const totalWeight = latestESP32Data.weight;
    const emptyWeight = currentConfig.empty_weight;
    const fullWeight = currentConfig.full_weight;
    
    const netWeight = Math.max(0, totalWeight - emptyWeight);
    const maxGas = fullWeight - emptyWeight;
    const gasPercentage = Math.min(100, Math.max(0, (netWeight / maxGas) * 100));
    
    // Actualizar elementos del DOM
    document.getElementById('totalWeight').textContent = `${totalWeight.toFixed(3)} kg`;
    document.getElementById('netWeight').textContent = `${netWeight.toFixed(3)} kg`;
    document.getElementById('emptyWeight').textContent = `${emptyWeight} kg`;
    document.getElementById('gasInfo').innerHTML = `
        <div class="info-value">${netWeight.toFixed(3)} kg</div>
        <div class="info-label">Gas Disponible</div>
    `;
    
    // Actualizar medidor
    updateGauge(gasPercentage);
    
    // Actualizar informaci√≥n del sistema
    document.getElementById('dataSource').textContent = 'ESP32 MQTT';
    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
    document.getElementById('esp32Status').textContent = 'Conectado MQTT';
    
    // Actualizar indicador de conexi√≥n
    document.getElementById('connectionStatus').className = 'status-indicator status-connected';
    
    console.log(`‚úÖ Dashboard actualizado: ${totalWeight.toFixed(3)} kg ‚Üí ${gasPercentage.toFixed(1)}%`);
}

// Modificar la funci√≥n updateData existente para usar MQTT cuando est√© disponible
const originalUpdateData = updateData;
updateData = async function() {
    // Si hay datos MQTT recientes (menos de 30 segundos), usarlos
    if (latestESP32Data && (Date.now() - latestESP32Data.received_at) < 30000) {
        updateDataFromMQTT();
        return;
    }
    
    // Si no hay datos MQTT, usar API como fallback
    await originalUpdateData();
};
</script>
